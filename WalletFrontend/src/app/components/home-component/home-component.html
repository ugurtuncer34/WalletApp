<section>
    <h2>Transactions</h2>
    <!-- Filter bar -->
    <div class="filters">
        <label>
            Month:
            <input type="month" [(ngModel)]="selectedMonth" (ngModelChange)="reload()">
        </label>

        <label>
            Account:
            <select [(ngModel)]="selectedAccountId" (change)="reload()">
                <option [ngValue]="null">All</option>
                <option *ngFor="let a of accounts$ | async" [ngValue]="a.id">{{ a.name }}</option>
            </select>
        </label>

        <label>
            Category:
            <select [(ngModel)]="selectedCategoryId" (change)="reload()">
                <option [ngValue]="null">All</option>
                <option *ngFor="let c of categories$ | async" [ngValue]="c.id">{{ c.name }}</option>
            </select>
        </label>
    </div>
    <table *ngIf="transactions$ | async as list; else loading">
        <!-- async pipe subscribes/unsubscribes automatically and exposes the array as list -->
        <thead>
            <tr>
                <th>Date</th>
                <th>Account</th>
                <th>Category</th>
                <th>Direction</th>
                <th>Amount</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            <tr *ngFor="let t of list; trackBy: trackById">
                <!-- Date -->
                <td *ngIf="editingId !== t.id">{{ t.date | date:'yyyy-MM-dd' }}</td>
                <td *ngIf="editingId === t.id">
                    <input type="date" [(ngModel)]="editTxn!.date">
                </td>

                <!-- Account -->
                <td *ngIf="editingId !== t.id">{{ t.accountName }}</td>
                <td *ngIf="editingId === t.id">
                    <select [(ngModel)]="editTxn!.accountId">
                        <option *ngFor="let a of accounts$ | async" [ngValue]="a.id">{{ a.name }}</option>
                    </select>
                </td>

                <!-- Category -->
                <td *ngIf="editingId !== t.id">{{ t.categoryName }}</td>
                <td *ngIf="editingId === t.id">
                    <select [(ngModel)]="editTxn!.categoryId">
                        <option *ngFor="let c of categories$ | async" [ngValue]="c.id">{{ c.name }}</option>
                    </select>
                </td>

                <!-- Direction -->
                <td class="direction-{{ t.direction | lowercase }}" *ngIf="editingId !== t.id">{{ t.direction }}</td>
                <td *ngIf="editingId === t.id">
                    <select [(ngModel)]="editTxn!.direction">
                        <option [ngValue]="1">Income</option>
                        <option [ngValue]="2">Expense</option>
                    </select>
                </td>

                <!-- Amount -->
                <td class="amount" *ngIf="editingId !== t.id">{{ t.amount | number:'1.2-2' }}</td>
                <td class="amount" *ngIf="editingId === t.id">
                    <input type="number" min="0.01" step="0.01" [(ngModel)]="editTxn!.amount">
                </td>

                <!-- Actions -->
                <td>
                    <!-- view mode buttons -->
                    <button class="icon-btn" style="margin-right: 2rem;" *ngIf="editingId !== t.id"
                        (click)="startEdit(t)">✎</button>
                    <button class="icon-btn" *ngIf="editingId !== t.id" (click)="txDelete(t.id)">✕</button>

                    <!-- edit mode buttons -->
                    <button class="add-btn" *ngIf="editingId === t.id" (click)="saveEdit(t.id)">Save</button>
                    <button class="icon-btn" *ngIf="editingId === t.id" (click)="cancelEdit()">✕</button>
                </td>
            </tr>

        </tbody>
        <tfoot>
            <tr>
                <td>
                    <input type="date" [(ngModel)]="newTransaction.date" required />
                </td>
                <td>
                    <select [(ngModel)]="newTransaction.accountId">
                        <option *ngFor="let a of accounts$ | async" [ngValue]="a.id">{{ a.name }}</option>
                    </select>
                </td>
                <td>
                    <select [(ngModel)]="newTransaction.categoryId">
                        <option *ngFor="let c of categories$ | async" [ngValue]="c.id">{{ c.name }}</option>
                    </select>
                </td>
                <td>
                    <select [(ngModel)]="newTransaction.direction">
                        <option [ngValue]="1">Income</option>
                        <option [ngValue]="2">Expense</option>
                    </select>
                </td>
                <td class="amount">
                    <input type="number" [(ngModel)]="newTransaction.amount" min="0.01" step="0.01" />
                </td>
                <td>
                    <button class="add-btn" (click)="txSave()">Add</button>
                </td>
            </tr>
        </tfoot>
    </table>

    <ng-template #loading>
        <p>Loading...</p>
    </ng-template>
</section>
<!-- Account Table -->
<section>
    <h2>Accounts</h2>
    <table *ngIf="accounts$ | async as acclist; else loading">
        <thead>
            <tr>
                <th>Account Name</th>
                <th>Currency</th>
                <th class="amount">Balance</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @for (a of acclist; track a.id) {
            <tr>
                <!-- Name -->
                <td *ngIf="editingAccountId !== a.id">{{ a.name }}</td>
                <td *ngIf="editingAccountId === a.id">
                    <input type="text" [(ngModel)]="editAccount!.name">
                </td>

                <!-- Currency -->
                <td *ngIf="editingAccountId !== a.id">{{ a.currency }}</td>
                <td *ngIf="editingAccountId === a.id">
                    <select [(ngModel)]="editAccount!.currency">
                        <option [ngValue]="1">TRY</option>
                        <option [ngValue]="2">EUR</option>
                        <option [ngValue]="3">USD</option>
                    </select>
                </td>

                <!-- Balance (read‑only) -->
                <td class="amount">{{ (balance$(a.id) | async) ?? '…' }}</td>

                <!-- Actions -->
                <td>
                    <!-- view mode -->
                    <button class="icon-btn" *ngIf="editingAccountId !== a.id" (click)="startEditAccount(a)">✎</button>
                    <button class="icon-btn" *ngIf="editingAccountId !== a.id" (click)="deleteAccount(a.id)">✕</button>

                    <!-- edit mode -->
                    <button class="add-btn" *ngIf="editingAccountId === a.id"
                        (click)="saveEditAccount(a.id)">Save</button>
                    <button class="icon-btn" *ngIf="editingAccountId === a.id" (click)="cancelEditAccount()">✕</button>
                </td>
            </tr>
            }
        </tbody>
        <tfoot>
            <tr>
                <td>
                    <input type="text" [(ngModel)]="newAccount.name" placeholder="New account name">
                </td>
                <td>
                    <select [(ngModel)]="newAccount.currency">
                        <option [ngValue]="1">TRY</option>
                        <option [ngValue]="2">EUR</option>
                        <option [ngValue]="3">USD</option>
                    </select>
                </td>
                <td class="amount">—</td>
                <td><button class="add-btn" (click)="createAccount()">Add</button></td>
            </tr>
        </tfoot>
    </table>
</section>
<section>
    <h2>Categories</h2>
    <table *ngIf="categories$ | async as ctglist; else loading">
        <thead>
            <tr>
                <td>
                    Category Name
                </td>
            </tr>
        </thead>
        <tbody>
            <tr *ngFor="let c of ctglist">
                <td>{{c.name}}</td>
            </tr>
        </tbody>
    </table>
</section>