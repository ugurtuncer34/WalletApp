<div class="container-fluid py-3 px-0">
    <div class="row  gx-3 gy-3">
        <section class="col-lg-8 col-12 px-3">
            <h2>Transactions</h2>
            <!-- Filter bar -->
            <div class="filters">
                <label>
                    Month:
                    <input type="month" [(ngModel)]="selectedMonth" (ngModelChange)="reload()">
                </label>

                <label>
                    Account:
                    <select [(ngModel)]="selectedAccountId" (change)="reload()">
                        <option [ngValue]="null">All</option>
                        <option *ngFor="let a of accounts$ | async" [ngValue]="a.id">{{ a.name }}</option>
                    </select>
                </label>

                <label>
                    Category:
                    <select [(ngModel)]="selectedCategoryId" (change)="reload()">
                        <option [ngValue]="null">All</option>
                        <option *ngFor="let c of categories$ | async" [ngValue]="c.id">{{ c.name }}</option>
                    </select>
                </label>
            </div>
            <div class="table-wrap">
                <table *ngIf="transactions$ | async as list; else loading">
                    <!-- async pipe subscribes/unsubscribes automatically and exposes the array as list -->
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Account</th>
                            <th>Category</th>
                            <th>Direction</th>
                            <th>Amount</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let t of list; trackBy: trackById">
                            <!-- Date -->
                            <td *ngIf="editingId !== t.id">{{ t.date | date:'yyyy-MM-dd' }}</td>
                            <td *ngIf="editingId === t.id">
                                <input type="date" [(ngModel)]="editTxn!.date">
                            </td>

                            <!-- Account -->
                            <td *ngIf="editingId !== t.id">{{ t.accountName }}</td>
                            <td *ngIf="editingId === t.id">
                                <select [(ngModel)]="editTxn!.accountId">
                                    <option *ngFor="let a of accounts$ | async" [ngValue]="a.id">{{ a.name }}</option>
                                </select>
                            </td>

                            <!-- Category -->
                            <td *ngIf="editingId !== t.id">{{ t.categoryName }}</td>
                            <td *ngIf="editingId === t.id">
                                <select [(ngModel)]="editTxn!.categoryId">
                                    <option *ngFor="let c of categories$ | async" [ngValue]="c.id">{{ c.name }}</option>
                                </select>
                            </td>

                            <!-- Direction -->
                            <td class="direction-{{ t.direction | lowercase }}" *ngIf="editingId !== t.id">{{
                                t.direction }}
                            </td>
                            <td *ngIf="editingId === t.id">
                                <select [(ngModel)]="editTxn!.direction">
                                    <option [ngValue]="1">Income</option>
                                    <option [ngValue]="2">Expense</option>
                                </select>
                            </td>

                            <!-- Amount -->
                            <td class="amount" *ngIf="editingId !== t.id">{{ t.amount | number:'1.2-2' }}</td>
                            <td class="amount" *ngIf="editingId === t.id">
                                <input type="number" min="0.01" step="0.01" [(ngModel)]="editTxn!.amount">
                            </td>

                            <!-- Actions -->
                            <td>
                                <!-- view mode buttons -->
                                <button class="icon-btn" *ngIf="editingId !== t.id" (click)="startEdit(t)">✎</button>
                                <button class="icon-btn" *ngIf="editingId !== t.id" (click)="txDelete(t.id)">✕</button>

                                <!-- edit mode buttons -->
                                <button class="add-btn" *ngIf="editingId === t.id"
                                    (click)="saveEdit(t.id)">Save</button>
                                <button class="icon-btn" *ngIf="editingId === t.id" (click)="cancelEdit()">✕</button>
                            </td>
                        </tr>

                    </tbody>
                </table>
                <form class="tx-form" (ngSubmit)="txSave()">
                    <input type="date" [(ngModel)]="newTransaction.date" name="date" required />

                    <select [(ngModel)]="newTransaction.accountId" name="accountId" required>
                        <option *ngFor="let a of accounts$ | async" [ngValue]="a.id">{{ a.name }}</option>
                    </select>

                    <select [(ngModel)]="newTransaction.categoryId" name="categoryId" required>
                        <option *ngFor="let c of categories$ | async" [ngValue]="c.id">{{ c.name }}</option>
                    </select>

                    <select [(ngModel)]="newTransaction.direction" name="direction" required>
                        <option [ngValue]="1">Income</option>
                        <option [ngValue]="2">Expense</option>
                    </select>

                    <input type="number" [(ngModel)]="newTransaction.amount" name="amount" min="0.01" step="0.01"
                        required class="amount-input" />

                    <button type="submit" class="add-btn">Add</button>
                </form>
            </div>
            <ng-template #loading>
                <p>Loading...</p>
            </ng-template>
        </section>
        <!-- Account Table -->
        <section class="col-lg-4 col-12 py-5">
            <h2>Accounts</h2>
            <table *ngIf="accounts$ | async as acclist; else loading">
                <thead>
                    <tr>
                        <th>Account Name</th>
                        <th>Currency</th>
                        <th class="amount">Balance</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    @for (a of acclist; track a.id) {
                    <tr>
                        <!-- Name -->
                        <td *ngIf="editingAccountId !== a.id">{{ a.name }}</td>
                        <td *ngIf="editingAccountId === a.id">
                            <input type="text" [(ngModel)]="editAccount!.name">
                        </td>

                        <!-- Currency -->
                        <td *ngIf="editingAccountId !== a.id">{{ a.currency }}</td>
                        <td *ngIf="editingAccountId === a.id">
                            <select [(ngModel)]="editAccount!.currency">
                                <option [ngValue]="1">TRY</option>
                                <option [ngValue]="2">EUR</option>
                                <option [ngValue]="3">USD</option>
                            </select>
                        </td>

                        <!-- Balance (read‑only) -->
                        <td class="amount">{{ (balance$(a.id) | async) ?? '…' }}</td>

                        <!-- Actions -->
                        <td>
                            <!-- view mode -->
                            <button class="icon-btn" *ngIf="editingAccountId !== a.id"
                                (click)="startEditAccount(a)">✎</button>
                            <button class="icon-btn" *ngIf="editingAccountId !== a.id"
                                (click)="deleteAccount(a.id)">✕</button>

                            <!-- edit mode -->
                            <button class="add-btn" *ngIf="editingAccountId === a.id"
                                (click)="saveEditAccount(a.id)">Save</button>
                            <button class="icon-btn" *ngIf="editingAccountId === a.id"
                                (click)="cancelEditAccount()">✕</button>
                        </td>
                    </tr>
                    }
                </tbody>
            </table>
            <form class="add-form" (ngSubmit)="createAccount()">
                <input [(ngModel)]="newAccount.name" name="name" placeholder="New account name" required>
                <select [(ngModel)]="newAccount.currency" name="currency" required>
                    <option [ngValue]="1">TRY</option>
                    <option [ngValue]="2">EUR</option>
                    <option [ngValue]="3">USD</option>
                </select>
                <button type="submit" class="add-btn">Add</button>
            </form>

            <!-- </section>
        <section> -->

            <h2 style="padding-top: 1rem;">Categories</h2>
            <table *ngIf="categories$ | async as ctglist; else loading">
                <thead>
                    <tr>
                        <th>
                            Category Name
                        </th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let c of ctglist">
                        <td *ngIf="editingCategoryId !== c.id">{{ c.name }}</td>
                        <td *ngIf="editingCategoryId === c.id">
                            <input type="text" [(ngModel)]="editCategory!.name">
                        </td>

                        <td>
                            <button class="icon-btn" *ngIf="editingCategoryId !== c.id"
                                (click)="startEditCategory(c)">✎</button>
                            <button class="icon-btn" *ngIf="editingCategoryId !== c.id"
                                (click)="deleteCategory(c.id)">✕</button>

                            <button class="add-btn" *ngIf="editingCategoryId === c.id"
                                (click)="saveEditCategory(c.id)">Save</button>
                            <button class="icon-btn" *ngIf="editingCategoryId === c.id"
                                (click)="cancelEditCategory()">✕</button>
                        </td>
                    </tr>
                </tbody>
            </table>
            <form class="add-form" (ngSubmit)="createCategory()">
                <input [(ngModel)]="newCategory.name" name="name" placeholder="New category name" required>
                <button type="submit" class="add-btn">Add</button>
            </form>
        </section>
    </div>
</div>